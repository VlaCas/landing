document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("preorderForm");if(!e)return;const t=e.querySelector("#pre_name"),n=e.querySelector("#pre_whatsapp"),r=e.querySelector("#pre_email"),s=e.querySelector("#pre_terms"),o=e.querySelector('button[type="submit"]');function a(e,t){if(!e)return;e.classList.remove("is-valid"),e.classList.add("is-invalid");const n=function(e){const t=e.parentNode;let n=t.querySelector(".invalid-feedback");return n||(n=document.createElement("div"),n.className="invalid-feedback",t.appendChild(n)),n}(e);n.textContent=t}function i(e){if(!e)return;e.classList.remove("is-invalid"),e.classList.add("is-valid");const t=e.parentNode.querySelector(".invalid-feedback");t&&(t.textContent="")}function c(){e.parentNode.querySelectorAll(".alert").forEach(function(e){e.remove()})}function d(t,n){c();const r=document.createElement("div");return r.className="alert alert-"+t+" mt-3",r.setAttribute("role","success"===t?"status":"alert"),r.textContent=n,e.parentNode.insertBefore(r,e.nextSibling),r}function l(){const e=(t.value||"").trim();if(e.length<2)return a(t,"Introduce un nombre válido (mínimo 2 caracteres)."),!1;return/^[A-Za-zÀ-ÖØ-öø-ÿñÑáéíóúÁÉÍÓÚüÜ'`´.\- ]+$/.test(e)?(i(t),!0):(a(t,"El nombre contiene caracteres no permitidos."),!1)}function u(){const e=(n.value||"").trim().replace(/\s|\-|\(|\)/g,"");return/^\+?\d{9,15}$/.test(e)?(i(n),!0):(a(n,"Número de teléfono no válido. Formato: +34123456789 o 9-15 dígitos."),!1)}function m(){const e=(r.value||"").trim();return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?(i(r),!0):(a(r,"Email no válido."),!1)}function f(){if(!s.checked){const e=s.parentNode;let t=e.querySelector(".invalid-feedback");return t||(t=document.createElement("div"),t.className="invalid-feedback",e.appendChild(t)),t.textContent="Debes aceptar la política para continuar.",s.classList.add("is-invalid"),!1}s.classList.remove("is-invalid");const e=s.parentNode.querySelector(".invalid-feedback");return e&&(e.textContent=""),!0}function v(e,t){o&&(e?(o.disabled=!0,t.value=o.textContent,o.textContent="Enviando..."):(o.disabled=!1,o.textContent=t.value||"Enviar"))}t.addEventListener("input",l),n.addEventListener("input",u),r.addEventListener("input",m),s.addEventListener("change",f),e.addEventListener("submit",async function(o){o.preventDefault(),c();const i=l(),p=u(),g=m(),y=f();if(!(i&&p&&g&&y)){const t=e.querySelector(".is-invalid");return void(t&&t.focus())}const h={value:""};v(!0,h);const E={name:(t.value||"").trim(),whatsapp:(n.value||"").trim(),email:(r.value||"").trim(),terms:s.checked?1:0},b=e.getAttribute("data-endpoint")||"https://preorform.fuegofest.es/api/customers";try{const t=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}),n=await async function(e){try{return await e.json()}catch(e){return null}}(t);if(!t.ok){const e=new Error("HTTP_ERROR");throw e.status=t.status,e.body=n,e}d("success",n&&n.message||"Reserva recibida. Te contactaremos por WhatsApp cuando haya disponibilidad."),e.reset(),e.querySelectorAll(".is-valid").forEach(function(e){e.classList.remove("is-valid")})}catch(s){if([t,n,r].forEach(function(e){e&&e.classList.remove("is-valid")}),s&&s.status){const t=s.status,o=s.body||{};if(409===t||"whatsapp_exists"===o.error){if("email_exists"===o.error){const e=o.message||"Este email ya está registrado.";a(r,e),r&&r.focus()}else if("whatsapp_exists"===o.error){const e=o.message||"Este WhatsApp ya está registrado.";a(n,e),n&&n.focus()}d("danger",o.message||"Este WhatsApp ya está registrado.")}else if(400===t)if(o&&o.errors&&"object"==typeof o.errors){Object.keys(o.errors).forEach(function(t){let n=e.querySelector('[name="'+t+'"]');if(!n){const r=String(t).split(/\.|\[|\]/).filter(Boolean),s=r.length?r[r.length-1]:t;n=e.querySelector('[name="'+s+'"], [name$="['+s+']"], [name$=".'+s+'"], #'+s+', [id$="'+s+'"]')}if(n)a(n,o.errors[t]);else{const n=document.createElement("div");n.className="alert alert-danger mt-3",n.setAttribute("role","alert"),n.textContent=o.errors[t],e.parentNode.insertBefore(n,e.nextSibling)}}),d("danger",o.message||"Ya existe un registro con esos datos.");const t=e.querySelector(".is-invalid");t&&t.focus()}else{const e=o.message||"Ya existe un registro con esos datos.";d("danger",e),"email_exists"===o.error?(a(r,e),r&&r.focus()):"whatsapp_exists"===o.error&&(a(n,e),n&&n.focus())}else d("danger",429===t?o.message||"Demasiadas solicitudes. Intenta de nuevo en unos minutos.":t>=500?o.message||"Error del servidor. Intenta de nuevo más tarde.":o.message||"Error al enviar. Intenta de nuevo más tarde.")}else d("danger","No se pudo conectar con el servidor. Revisa tu conexión o CORS (dominio permitido) e inténtalo de nuevo.")}finally{v(!1,h)}})});